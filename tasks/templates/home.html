{% extends 'base.html' %}

{% block title %}Inicio | MovieHub{% endblock %}

{% block content %}
{% if user.is_authenticated %}
    <!-- Vista mejorada para usuarios autenticados -->
    <div class="user-dashboard">
        <!-- Header personalizado con bienvenida -->
        <div class="section" style="background: linear-gradient(135deg, #7b1fa2, #9c27b0); padding: 40px 0;">
            <div class="container">
                <div class="row">
                    <div class="col s12">
                        <h3 class="white-text">Bienvenido de vuelta, {{ user.username }}!</h3>
                        <p class="white-text flow-text">Hemos seleccionado algunas películas para ti hoy</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel principal con estadísticas y acciones rápidas -->
        <div class="section white">
            <div class="container">
                <div class="row">
                    <!-- Panel izquierdo con estadísticas del usuario -->
                    <div class="col s12 m4">
                        <div class="card gradient-card z-depth-3">
                            <div class="card-content white-text">
                                <span class="card-title">Tu actividad</span>
                                <div class="divider"></div>
                                <div class="stat-item">
                                    <i class="material-icons left">movie</i>
                                    <span>Películas vistas: <b>24</b></span>
                                </div>
                                <div class="stat-item">
                                    <i class="material-icons left">star</i>
                                    <span>Reseñas escritas: <b>12</b></span>
                                </div>
                                <div class="stat-item">
                                    <i class="material-icons left">favorite</i>
                                    <span>Películas favoritas: <b>18</b></span>
                                </div>
                                <div class="stat-item">
                                    <i class="material-icons left">bookmark</i>
                                    <span>Lista de pendientes: <b>7</b></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Acciones rápidas -->
                        <div class="collection with-header z-depth-2">
                            <div class="collection-header purple lighten-4"><h5>Acciones rápidas</h5></div>
                            <a href="{% url 'peliculasFavoritas' %}" class="collection-item waves-effect"><i class="material-icons left">rate_review</i>Escribir reseña</a>
                            <a href="{% url 'configurar_perfil' %}" class="collection-item waves-effect"><i class="material-icons left">settings</i>Configurar perfil</a>
                        </div>
                    </div>
                    
                    <!-- Panel central con recomendaciones -->
                    <div class="col s12 m8">
                        <div class="card z-depth-2">
                            <div class="card-content">
                                <span class="card-title purple-text text-darken-2">
                                    <i class="material-icons left">thumb_up</i>Recomendado para ti
                                </span>
                                
                                <div class="divider"></div>
                                <br>
                                
                                <div class="row movie-recommendations" id="api-recommendations">
                                    <!-- Las películas recomendadas se cargarán aquí desde la API -->
                                    <div class="col s12 center">
                                        <div class="preloader-wrapper big active">
                                            <div class="spinner-layer spinner-blue-only">
                                                <div class="circle-clipper left">
                                                    <div class="circle"></div>
                                                </div><div class="gap-patch">
                                                    <div class="circle"></div>
                                                </div><div class="circle-clipper right">
                                                    <div class="circle"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <p>Cargando recomendaciones...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Películas populares -->
                        <div class="card z-depth-2">
                            <div class="card-content">
                                <span class="card-title purple-text text-darken-2">
                                    <i class="material-icons left">trending_up</i>Tendencias esta semana
                                </span>
                                
                                <div class="divider"></div>
                                <br>
                                
                                <div class="trending-movies" id="api-trending">
                                    <!-- Las películas en tendencia se cargarán aquí desde la API -->
                                    <div class="row">
                                        <div class="col s12 center">
                                            <div class="preloader-wrapper big active">
                                                <div class="spinner-layer spinner-blue-only">
                                                    <div class="circle-clipper left">
                                                        <div class="circle"></div>
                                                    </div><div class="gap-patch">
                                                        <div class="circle"></div>
                                                    </div><div class="circle-clipper right">
                                                        <div class="circle"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <p>Cargando tendencias...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estilos específicos para usuarios logueados -->
    <style>
        /* Estilos para la tarjeta con gradiente */
        .gradient-card {
            background: linear-gradient(45deg, #7b1fa2, #e91e63);
            border-radius: 8px;
        }
        
        .stat-item {
            margin: 15px 0;
            display: flex;
            align-items: center;
        }
        
        .stat-item i {
            margin-right: 10px;
        }
        
        /* Estilos para las películas recomendadas */
        .recommended-movie {
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            height: 100%;
            background-color: #fff;
        }
        
        .movie-poster {
            position: relative;
            overflow: hidden;
        }
        
        .movie-poster img {
            transition: transform 0.3s ease;
            height: 250px;
            width: 100%;
            object-fit: cover;
        }
        
        .recommended-movie:hover .movie-poster img {
            transform: scale(1.05);
        }
        
        .movie-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
        }
        
        .recommended-movie:hover .movie-overlay {
            opacity: 1;
        }
        
        .movie-rating {
            align-self: flex-start;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 8px;
            border-radius: 15px;
            display: flex;
            align-items: center;
        }
        
        .movie-actions {
            align-self: flex-end;
        }
        
        .movie-actions a {
            margin-left: 5px;
        }
        
        .movie-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .movie-info h5 {
            margin-top: 0;
            color: #7b1fa2;
        }
        
        .match {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        /* Estilos para películas en tendencia */
        .trending-movie {
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        
        .trending-movie:hover {
            transform: translateY(-5px);
        }
        
        .trending-title {
            text-align: center;
            margin-top: 8px;
            font-weight: 500;
        }
        
        .trending-movie img {
            border-radius: 6px;
            height: 150px;
            width: 100%;
            object-fit: cover;
        }
    </style>

    <!-- Script para cargar datos de la API -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiKey = "a5c892bf"; // Clave API de OMDb
            const trendingIds = ["tt0111161", "tt0068646", "tt0468569", "tt1375666", "tt0109830", "tt0137523", "tt0120737", "tt0167260", "tt0080684", "tt0133093"]; // Top 10 IMDb
            
            // IDs para recomendaciones personalizadas (podrían venir de la base de datos según preferencias del usuario)
            const recommendationIds = ["tt0816692", "tt1745960", "tt15398776", "tt10954984", "tt10293406"];
            
            // Cargar películas recomendadas
            loadMovies('api-recommendations', recommendationIds, true);
            
            // Cargar películas en tendencia
            loadMovies('api-trending', trendingIds, false);
            
            function loadMovies(containerId, movieIds, isRecommended) {
                const container = document.getElementById(containerId);
                let htmlContent = '';
                
                if (isRecommended) {
                    htmlContent = '<div class="row">';
                } else {
                    htmlContent = '<div class="row" style="margin-bottom: 0;">';
                }
                
                // Limitar a 4 películas para tendencias y 2 para recomendaciones
                const limit = isRecommended ? 2 : 4;
                const loadedIds = [];
                
                // Función recursiva para cargar películas hasta alcanzar el límite
                function fetchNextMovie(index) {
                    if (index >= movieIds.length || loadedIds.length >= limit) {
                        if (isRecommended) {
                            htmlContent += '</div>';
                        } else {
                            htmlContent += '</div>';
                        }
                        container.innerHTML = htmlContent;
                        addMovieEvents();
                        return;
                    }
                    
                    const movieId = movieIds[index];
                    
                    fetch(`https://www.omdbapi.com/?i=${movieId}&apikey=${apiKey}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.Response === "True") {
                                loadedIds.push(movieId);
                                
                                if (isRecommended) {
                                    htmlContent += createRecommendedMovieCard(data);
                                } else {
                                    htmlContent += createTrendingMovieCard(data);
                                }
                            }
                            fetchNextMovie(index + 1);
                        })
                        .catch(error => {
                            console.error("Error fetching movie data:", error);
                            fetchNextMovie(index + 1);
                        });
                }
                
                fetchNextMovie(0);
            }
            
            function createRecommendedMovieCard(movieData) {
                return `
                    <div class="col s12 m6">
                        <div class="recommended-movie z-depth-1 hoverable">
                            <div class="movie-poster">
                                <img src="${movieData.Poster !== "N/A" ? movieData.Poster : 'https://via.placeholder.com/300x450?text=No+Poster'}" class="responsive-img">
                                <div class="movie-overlay">
                                    <div class="movie-rating amber-text">
                                        <i class="material-icons tiny">star</i> ${movieData.imdbRating !== "N/A" ? movieData.imdbRating : 'N/A'}
                                    </div>
                                    <div class="movie-actions">
                                        <a href="#" class="btn-floating btn-small waves-effect waves-light red">
                                            <i class="material-icons">favorite</i>
                                        </a>
                                        <a href="#" class="btn-floating btn-small waves-effect waves-light blue">
                                            <i class="material-icons">bookmark</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="movie-info">
                                <h5>${movieData.Title}</h5>
                                <p class="truncate">${movieData.Genre}</p>
                                <p class="match">${Math.floor(Math.random() * 30) + 70}% coincidencia con tus gustos</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            function createTrendingMovieCard(movieData) {
                return `
                    <div class="col s6 m3">
                        <div class="trending-movie hoverable">
                            <img src="${movieData.Poster !== "N/A" ? movieData.Poster : 'https://via.placeholder.com/300x450?text=No+Poster'}" class="responsive-img z-depth-1">
                            <p class="trending-title truncate">${movieData.Title}</p>
                        </div>
                    </div>
                `;
            }
            
            function addMovieEvents() {
                // Agregar eventos hover a las películas recomendadas
                document.querySelectorAll('.recommended-movie').forEach(movie => {
                    movie.addEventListener('mouseenter', function() {
                        this.querySelector('.movie-overlay').style.opacity = '1';
                    });
                    
                    movie.addEventListener('mouseleave', function() {
                        this.querySelector('.movie-overlay').style.opacity = '0';
                    });
                });
                
                // Agregar efecto hover a las películas en tendencia
                document.querySelectorAll('.trending-movie').forEach(movie => {
                    movie.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateY(-5px)';
                    });
                    
                    movie.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateY(0)';
                    });
                });
            }
        });
    </script>
{% else %}
    <!-- Vista para usuarios no autenticados (se mantiene igual) -->
    <!-- ... (todo el contenido existente para usuarios no autenticados) ... -->
{% endif %}
{% endblock %}
